$schema: http://json-schema.org/draft-07/schema#
$id: https://serverlessworkflow.io/schemas/1.0.0/workflow.yaml
type: object
properties:
  id:
    type: string
    description: "Unique workflow identifier"
  specVersion:
    type: string
    enum: ["1.0"]
    description: "Serverless Workflow specification version"
  version:
    type: string
    description: "Workflow version"
  name:
    type: string
    description: "Workflow name"
  description:
    type: string
    description: "Workflow description"
  start:
    type: [string, object]
    description: "Starting state name or definition"
    oneOf:
      - type: string
      - $ref: "#/$defs/StartDefinition"
  functions:
    type: array
    items:
      $ref: "#/$defs/Function"
    description: "List of function definitions"
  events:
    type: array
    items:
      $ref: "#/$defs/Event"
    description: "List of event definitions"
  retries:
    type: array
    items:
      $ref: "#/$defs/Retry"
    description: "List of retry definitions"
  auth:
    type: array
    items:
      $ref: "#/$defs/Auth"
    description: "List of authentication definitions"
  states:
    type: array
    items:
      $ref: "#/$defs/State"
    description: "List of workflow states"
  subWorkflows:
    type: array
    items:
      $ref: "#"
    description: "List of embedded sub-workflows"
required: [id, specVersion, states]
$defs:
  Function:
    type: object
    properties:
      name:
        type: string
        pattern: "^[^.]+$"
        description: "Unique function name, no dots allowed"
      type:
        type: string
        enum: [custom, expression, rest, rpc, asyncapi, graphql]
        description: "Type of function (custom, expression, rest, rpc, asyncapi, graphql)"
      operation:
        type: string
        description: "Operation identifier, may include dots (e.g., 'AGENT1.method1')"
      comment:
        type: string
        description: "Quoted string explaining the shape of the returned data, e.g., 'Returns int', 'Returns object (e.g., {\"key\": \"value\"})'"
    required: [name, type, operation]
  Event:
    type: object
    properties:
      name:
        type: string
        description: "Unique event name"
      type:
        type: string
        description: "Event type"
      source:
        type: string
        description: "Event source"
      correlation:
        type: array
        items:
          type: object
          properties:
            contextAttributeName:
              type: string
            contextAttributeValue:
              type: string
    required: [name, type, source]
  Retry:
    type: object
    properties:
      name:
        type: string
        description: "Unique retry strategy name"
      maxAttempts:
        type: [string, integer]
        description: "Maximum number of retries"
      delay:
        type: string
        description: "Delay between retries in ISO 8601 duration format"
      multiplier:
        type: number
        description: "Multiplier for delay between retries"
    required: [name]
  Auth:
    type: object
    properties:
      name:
        type: string
        description: "Unique auth definition name"
      scheme:
        type: string
        enum: [basic, bearer, oauth2]
        description: "Authentication scheme"
      properties:
        type: object
        description: "Authentication properties (e.g., username, password, token)"
    required: [name, scheme]
  StartDefinition:
    type: object
    properties:
      stateName:
        type: string
        description: "Name of the starting state"
      schedule:
        type: [string, object]
        description: "Schedule for starting the workflow"
    required: [stateName]
  State:
    type: object
    oneOf:
      - $ref: "#/$defs/OperationState"
      - $ref: "#/$defs/ForEachState"
      - $ref: "#/$defs/SwitchState"
      - $ref: "#/$defs/SubflowState"
      - $ref: "#/$defs/ParallelState"
      - $ref: "#/$defs/EndState"
      - $ref: "#/$defs/EventState"
      - $ref: "#/$defs/DelayState"
      - $ref: "#/$defs/InjectState"
  OperationState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: operation
      actions:
        type: array
        items:
          $ref: "#/$defs/Action"
      actionMode:
        type: string
        enum: [sequential, parallel]
        description: "Execution mode for actions (sequential or parallel)"
      stateDataFilter:
        $ref: "#/$defs/StateDataFilter"
      transition:
        type: string
        description: "Next state to transition to"
      end:
        type: boolean
        description: "End workflow execution"
    required: [name, type, actions]
    oneOf:
      - required: [transition]
      - required: [end]
  ForEachState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: foreach
      inputCollection:
        type: string
        description: "JQ expression selecting the list to iterate over"
      iterationParam:
        type: string
        description: "Parameter name for each iteration item"
      iterator:
        type: array
        items:
          $ref: "#/$defs/State"
        description: "States to execute for each item; use OperationState or SubflowState with end: true, avoid type: end"
      stateDataFilter:
        $ref: "#/$defs/StateDataFilter"
      transition:
        type: string
        description: "Next state to transition to"
      end:
        type: boolean
        description: "End workflow execution"
    required: [name, type, inputCollection]
    oneOf:
      - required: [transition]
      - required: [end]
  SwitchState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: switch
      dataConditions:
        type: array
        items:
          type: object
          properties:
            condition:
              type: string
              description: "JQ expression for condition evaluation"
            transition:
              type: string
              description: "Next state to transition to if condition is true"
            end:
              type: boolean
              description: "End workflow execution if condition is true"
          required: [condition]
          oneOf:
            - required: [transition]
            - required: [end]
        description: "Conditions for routing to states"
      defaultCondition:
        type: object
        properties:
          transition:
            type: string
            description: "Default state to transition to"
          end:
            type: boolean
            description: "End workflow execution"
        oneOf:
          - required: [transition]
          - required: [end]
      stateDataFilter:
        $ref: "#/$defs/StateDataFilter"
      transition:
        type: string
        description: "Next state to transition to"
      end:
        type: boolean
        description: "End workflow execution"
    required: [name, type]  # Removed oneOf from top level
    # Removed oneOf constraint, relying on dataConditions/defaultCondition for flow control
  SubflowState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: subflow
      workflowId:
        type: string
        description: "ID of the sub-workflow to execute"
      stateDataFilter:
        $ref: "#/$defs/StateDataFilter"
      transition:
        type: string
        description: "Next state to transition to"
      end:
        type: boolean
        description: "End workflow execution"
    required: [name, type, workflowId]
    oneOf:
      - required: [transition]
      - required: [end]
  ParallelState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: parallel
      branches:
        type: array
        items:
          type: object
          properties:
            name:
              type: string
            states:
              type: array
              items:
                $ref: "#/$defs/State"
              description: "States within the branch"
          required: [name, states]
        description: "Parallel execution branches"
      completionType:
        type: string
        enum: [allOf, atLeast]
        description: "Condition for branch completion"
      stateDataFilter:
        $ref: "#/$defs/StateDataFilter"
      transition:
        type: string
        description: "Next state to transition to"
      end:
        type: boolean
        description: "End workflow execution"
    required: [name, type, branches]
    oneOf:
      - required: [transition]
      - required: [end]
  EndState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: end
    required: [name, type]
  EventState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: event
      onEvents:
        type: array
        items:
          type: object
          properties:
            eventRefs:
              type: array
              items:
                type: string
                description: "Reference to defined events"
            actions:
              type: array
              items:
                $ref: "#/$defs/Action"
            eventDataFilter:
              type: object
              properties:
                data:
                  type: string
                  description: "JQ expression to filter event data"
                toStateData:
                  type: string
                  description: "JSONPath to merge event data"
            transition:
              type: string
              description: "Next state to transition to"
            end:
              type: boolean
              description: "End workflow execution"
          required: [eventRefs]
          oneOf:
            - required: [transition]
            - required: [end]
        description: "Events and actions to process"
      stateDataFilter:
        $ref: "#/$defs/StateDataFilter"
      transition:
        type: string
        description: "Next state to transition to"
      end:
        type: boolean
        description: "End workflow execution"
    required: [name, type, onEvents]
    oneOf:
      - required: [transition]
      - required: [end]
  DelayState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: delay
      timeDelay:
        type: string
        description: "ISO 8601 duration for delay"
      stateDataFilter:
        $ref: "#/$defs/StateDataFilter"
      transition:
        type: string
        description: "Next state to transition to"
      end:
        type: boolean
        description: "End workflow execution"
    required: [name, type, timeDelay]
    oneOf:
      - required: [transition]
      - required: [end]
  InjectState:
    type: object
    properties:
      name:
        type: string
      type:
        type: string
        const: inject
      data:
        type: object
        description: "Data to inject into state"
      stateDataFilter:
        $ref: "#/$defs/StateDataFilter"
      transition:
        type: string
        description: "Next state to transition to"
      end:
        type: boolean
        description: "End workflow execution"
    required: [name, type, data]
    oneOf:
      - required: [transition]
      - required: [end]
  Action:
    type: object
    properties:
      name:
        type: string
      functionRef:
        type: [string, object]
        properties:
          refName:
            type: string
            description: "Reference to a function name"
          arguments:
            type: object
            description: "Function arguments as a JQ expression"
        required: [refName]
      subflowRef:
        type: string
        description: "Reference to a sub-workflow ID"
      eventRef:
        type: string
        description: "Reference to an event definition"
      retryRef:
        type: string
        description: "Reference to a retry definition"
      dataOutput:
        type: string
        description: "JSONPath to merge action output, e.g., '.context.<StateName>Output.<functionName>' or '.context.<StateName>Output.<BranchName>Output' for branches"
    required: [functionRef]
  StateDataFilter:
    type: object
    properties:
      input:
        type: string
        description: "JQ expression to filter state input"
      output:
        type: string
        description: "JSONPath to merge state output, e.g., '.context'"
    required: []